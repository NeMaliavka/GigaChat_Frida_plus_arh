import logging
from aiogram import Bot
from typing import List, Dict
from app.config import ADMIN_ID

# --- 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ô –û–®–ò–ë–ö–ï –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ---
# –ù–∞—à–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –º—ã –¥–æ–±–∞–≤–∏–ª–∏

async def notify_admin_on_error(
    bot: Bot,
    user_id: int,
    username: str | None,
    error_description: str,
    history: List[Dict[str, str]]
):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ –≤ FSM-—Å—Ü–µ–Ω–∞—Ä–∏–∏.
    """
    if not ADMIN_ID:
        logging.warning("ADMIN_ID –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É—è HTML
    history_text = "\n".join([f"<b>{msg['role']}:</b> {msg['content']}" for msg in history])

    text = (
        f"üö® <b>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏!</b> üö®\n\n"
        f"<b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> <a href='tg://user?id={user_id}'>{username or user_id}</a>\n"
        f"<b>ID:</b> <code>{user_id}</code>\n"
        f"<b>–ü—Ä–æ–±–ª–µ–º–∞:</b> {error_description}\n\n"
        f"<b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</b>\n{history_text}\n\n"
        f"<i>–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ!</i>"
    )

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode="HTML" –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å—Å—ã–ª–æ–∫ –∏ –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        await bot.send_message(ADMIN_ID, text, parse_mode="HTML")
        logging.info(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω –æ–± –æ—à–∏–±–∫–µ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}.")
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: {e}")


# --- 2. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û–ô –ê–ö–¢–ò–í–ù–û–°–¢–ò ---
# –í–∞—à–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –Ω–µ–º–Ω–æ–≥–æ —É–ª—É—á—à–µ–Ω–Ω–∞—è

async def notify_admin_on_suspicious_activity(
    bot: Bot,
    user_id: int,
    username: str | None,
    history: List[Dict[str, str]]
):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3 –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ä—è–¥).
    """
    if not ADMIN_ID:
        logging.warning("ADMIN_ID –Ω–µ —É–∫–∞–∑–∞–Ω –≤ –∫–æ–Ω—Ñ–∏–≥–µ. –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
        return

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É—è HTML
    history_text = "\n".join([f"<b>{msg['role']}:</b> {msg['content']}" for msg in history])
    
    text = (
        f"üïµÔ∏è‚Äç‚ôÇÔ∏è <b>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!</b> üïµÔ∏è‚Äç‚ôÇÔ∏è\n\n"
        f"<b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> <a href='tg://user?id={user_id}'>{username or user_id}</a>\n"
        f"<b>ID:</b> <code>{user_id}</code>\n"
        f"<b>–ü—Ä–∏—á–∏–Ω–∞:</b> –°–æ–≤–µ—Ä—à–∏–ª 3 –∏–ª–∏ –±–æ–ª–µ–µ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–¥—Ä—è–¥.\n\n"
        f"<b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:</b>\n{history_text}\n\n"
        f"<i>–ë–æ—Ç –ø—Ä–µ–∫—Ä–∞—Ç–∏–ª –æ—Ç–≤–µ—á–∞—Ç—å —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤.</i>"
    )
    
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º parse_mode="HTML" –¥–ª—è –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        await bot.send_message(chat_id=ADMIN_ID, text=text, parse_mode="HTML")
        logging.info(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {ADMIN_ID} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}.")
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É: {e}")
